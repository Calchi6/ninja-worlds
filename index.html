<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover,user-scalable=no"/>
<title>Ninja Worlds ‚Äî Instant Play (Mario Feel)</title>
<style>
  html,body{margin:0;height:100%;background:#1a0f0f;color:#fff;font:14px/1.2 -apple-system,system-ui,Segoe UI,Inter}
  canvas{display:block;width:100vw;height:100vh;background:#1a0f0f;touch-action:none}
  .overlay{position:fixed;inset:0;display:grid;place-items:center;background:rgba(0,0,0,.45);backdrop-filter:blur(6px);z-index:10}
  .panel{background:rgba(20,22,28,.92);border:1px solid rgba(255,255,255,.15);padding:18px 20px;border-radius:14px;min-width:260px}
  .panel h2{margin:.25em 0 10px;font:800 18px/1.2 system-ui}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .btn{border:0;border-radius:10px;padding:10px 14px;font-weight:800;background:#fff;color:#000;cursor:pointer}
  #hud{position:fixed;left:10px;top:10px;display:flex;gap:8px;z-index:6}
  .badge{background:rgba(0,0,0,.55);padding:6px 10px;border-radius:10px;font-weight:800}
  #bossbar{position:fixed;left:50%;transform:translateX(-50%);top:10px;z-index:6;display:none;gap:8px;align-items:center}
  #bossbar .bar{width:220px;height:10px;background:rgba(0,0,0,.35);border-radius:999px;overflow:hidden}
  #bossbar .fill{height:100%;background:#ff6e6e;width:100%}
  /* Touch */
  #touch{position:fixed;left:12px;right:12px;bottom:16px;display:flex;justify-content:space-between;align-items:flex-end;gap:12px;pointer-events:none;z-index:9}
  .pad{display:flex;gap:12px;pointer-events:auto}
  .tbtn{width:68px;height:68px;border-radius:999px;border:0;background:rgba(255,255,255,.12);
        color:#fff;font:800 14px system-ui;display:grid;place-items:center;backdrop-filter:blur(6px);
        box-shadow:inset 0 0 0 2px rgba(255,255,255,.15)}
  .tbtn:active{transform:scale(.97)}
  .lg{width:80px;height:80px}
  @media (min-width:900px){ #touch{display:none} }
</style>
</head>
<body>
<canvas id="game"></canvas>

<!-- HUD -->
<div id="hud" style="display:none">
  <div id="hp" class="badge">HP: ‚ù§‚ù§‚ù§</div>
  <div id="coins" class="badge">Coins: 0</div>
  <div id="spec" class="badge">Special: ‚Äî</div>
</div>
<div id="bossbar"><span class="badge">Boss</span><div class="bar"><div class="fill" id="bossfill"></div></div></div>

<!-- Start / Pause / Win -->
<div id="title" class="overlay">
  <div class="panel">
    <h2>Ninja Worlds ‚Äî Instant Play</h2>
    <p style="opacity:.85;margin:.2em 0 10px">WASD/Arrows move ¬∑ Space jump ¬∑ J attack ¬∑ Shift dash ¬∑ K special ¬∑ P pause</p>
    <div class="row"><button class="btn" id="play">Play</button></div>
  </div>
</div>
<div id="pause" class="overlay" style="display:none">
  <div class="panel">
    <h2>Paused</h2>
    <div class="row">
      <button class="btn" id="resume">Resume</button>
      <button class="btn" id="restart">Restart</button>
      <button class="btn" id="menu">Menu</button>
    </div>
  </div>
</div>
<div id="win" class="overlay" style="display:none">
  <div class="panel">
    <h2>You Win! üéâ</h2>
    <div class="row">
      <button class="btn" id="again">Play Again</button>
      <button class="btn" id="back">Menu</button>
    </div>
  </div>
</div>

<!-- Touch controls -->
<div id="touch">
  <div class="pad">
    <button class="tbtn lg" id="tLeft">‚óÄÔ∏é</button>
    <button class="tbtn lg" id="tRight">‚ñ∂Ô∏é</button>
  </div>
  <div class="pad">
    <button class="tbtn lg" id="tJump">‚§¥Ô∏é</button>
    <button class="tbtn" id="tAtk">Atk</button>
    <button class="tbtn" id="tDash">Dash</button>
    <button class="tbtn" id="tSpec">Spec</button>
  </div>
</div>

<script>
/* ===== Canvas @ CSS px ===== */
const C=document.getElementById('game'), g=C.getContext('2d');
function resize(){
  const dpr=devicePixelRatio||1;
  C.width=Math.round(innerWidth*dpr);
  C.height=Math.round(innerHeight*dpr);
  C.style.width=innerWidth+'px'; C.style.height=innerHeight+'px';
  g.setTransform(dpr,0,0,dpr,0,0);
}
resize(); addEventListener('resize', resize);

/* ===== Helpers ===== */
const clamp=(v,a,b)=>Math.max(a,Math.min(b,v));
const AABB=(a,b)=>a.x<b.x+b.w && a.x+a.w>b.x && a.y<b.y+b.h && a.y+a.h>b.y;
const vibrate = ms => { try{ if(navigator.vibrate) navigator.vibrate(ms); }catch(_){} };
const approach=(v,target,rate,dt)=> v + clamp(target - v, -rate*dt, rate*dt);

/* ===== Tiles/Level ===== */
const TILE=32;
function makeEmpty(w,h){ const L=[]; for(let y=0;y<h;y++){const r=new Array(w).fill(0); if(y>=h-3) r.fill(1); L.push(r);} return L; }
function buildLevel(){
  const W=120,H=18, L=makeEmpty(W,H);
  // gaps
  for(let x=20;x<=21;x++) L[H-3][x]=0;
  for(let x=46;x<=47;x++) L[H-3][x]=0;
  // blocks/coins
  for(let i=0;i<6;i++){ L[H-6][12+i]=2; } L[H-7][13]=3; L[H-7][15]=3;
  for(let i=0;i<6;i++){ L[H-9][34+i]=2; } L[H-10][36]=3;
  for(let i=0;i<8;i++){ L[H-8][64+i]=2; } L[H-9][66]=3; L[H-9][70]=3;
  L[H-4][28]=9; L[H-7][40]=6; // checkpoint + scroll
  L[H-4][58]=4; L[H-4][59]=4; L[H-4][60]=4; // spikes
  for(let i=0;i<10;i++){ L[H-5][W-28+i]=2; } // boss step
  L[H-4][W-6]=5; // flag
  return {w:W,h:H,map:L,name:'Instant v3'};
}
let Level=null, LEVEL_W=0, LEVEL_H=0;

/* ===== Player & Mario-ish Physics ===== */
const MAX_RUN=330;                    // top speed
const GROUND_ACCEL=7200;              // how fast we reach target on ground
const AIR_ACCEL=2000;                 // how fast we reach target in air
const GROUND_FRICTION=9000;           // how fast we stop on ground
const GRAV=2100, JUMP_V=640, MAX_FALL=1350, DASH=520;
const COYOTE_TIME=0.10, JUMP_BUF=0.12;
let coyote=0, jbuf=0;

const player={x:0,y:0,w:22,h:28,vx:0,vy:0,face:1,on:false,wasOn:false,jumps:0,maxJ:1,hp:3,coins:0,dashCd:0,attackT:0,iFrames:0,spawnX:0,spawnY:0};

let running=false, cam={x:0,y:0};
const HUD={hp:qs('#hp'), coins:qs('#coins'), spec:qs('#spec')};
const UI={title:qs('#title'),pause:qs('#pause'),win:qs('#win'),hud:qs('#hud')};
const BTN={play:qs('#play'),resume:qs('#resume'),restart:qs('#restart'),menu:qs('#menu'),again:qs('#again'),back:qs('#back')};
const BossUI={wrap:qs('#bossbar'), fill:qs('#bossfill')};
function qs(s){ return document.querySelector(s); }

/* Input */
const keys=Object.create(null);
addEventListener('keydown',e=>{
  const k=e.key.toLowerCase();
  if([' ','arrowleft','arrowright','arrowup','arrowdown'].includes(e.key)) e.preventDefault();
  keys[k]=true;
  if(k==='p' || e.key==='Escape') togglePause();
  if(k==='k') triggerSpecial();
});
addEventListener('keyup',e=>{ keys[e.key.toLowerCase()]=false; });
addEventListener('blur',()=>{ for(const k in keys) keys[k]=false; player.vx=0; });

/* Touch mapping */
function bindHold(id,down,up){ const b=qs(id); const press=e=>{e.preventDefault();down();}; const lift=e=>{e.preventDefault();up();};
  b.addEventListener('pointerdown',press); b.addEventListener('pointerup',lift);
  b.addEventListener('pointercancel',lift); b.addEventListener('pointerleave',lift);
}
bindHold('#tLeft', ()=>{keys.a=keys.arrowleft=true;}, ()=>{keys.a=keys.arrowleft=false;});
bindHold('#tRight',()=>{keys.d=keys.arrowright=true;},()=>{keys.d=keys.arrowright=false;});
bindHold('#tJump', ()=>{keys[' ']=keys.space=true;}, ()=>{keys[' ']=keys.space=false;});
bindHold('#tDash', ()=>{keys.shift=true;}, ()=>{keys.shift=false;});
bindHold('#tAtk',  ()=>{keys.j=true;}, ()=>{keys.j=false;});
bindHold('#tSpec', ()=>{triggerSpecial();}, ()=>{});

/* Tiles */
const solid = id => id===1||id===2;
const deadly = id => id===4;
function tileAt(px,py){
  const tx=Math.floor(px/TILE), ty=Math.floor(py/TILE);
  if(ty<0||ty>=LEVEL_H||tx<0||tx>=LEVEL_W) return 0;
  return Level.map[ty][tx];
}

/* Collisions */
function resolveX(ent, dx){
  ent.x += dx;
  const L = Math.floor(ent.x/TILE);
  const R = Math.floor((ent.x+ent.w-1)/TILE);
  const T = Math.floor(ent.y/TILE);
  const B = Math.floor((ent.y+ent.h-1)/TILE);
  for(let ty=T; ty<=B; ty++){
    for(let tx=L; tx<=R; tx++){
      const id = tileAt(tx*TILE+1, ty*TILE+1);
      if(solid(id)){
        if(dx>0) ent.x = tx*TILE - ent.w; else ent.x = (tx+1)*TILE;
        ent.vx = 0;
      }
      if(ent===player && deadly(id)) damage(1);
    }
  }
}
function resolveY(ent, dy){
  ent.y += dy;
  const L = Math.floor(ent.x/TILE);
  const R = Math.floor((ent.x+ent.w-1)/TILE);
  const T = Math.floor(ent.y/TILE);
  const B = Math.floor((ent.y+ent.h-1)/TILE);
  let on=false;
  for(let ty=T; ty<=B; ty++){
    for(let tx=L; tx<=R; tx++){
      const id = tileAt(tx*TILE+1, ty*TILE+1);
      if(solid(id)){
        if(dy>0){ ent.y = ty*TILE - ent.h; ent.vy=0; on=true; }
        else     { ent.y = (ty+1)*TILE; if(ent.vy<0) ent.vy=0; }
      }
      if(ent===player){
        if(id===3){ Level.map[ty][tx]=0; player.coins++; updateHUD(); }
        if(id===5 && !boss) win();
        if(id===6){ Level.map[ty][tx]=0; player.maxJ=2; HUD.spec.textContent='Special: ‚Äî (Double Jump Unlocked)'; }
        if(id===9){ player.spawnX=tx*TILE+4; player.spawnY=ty*TILE - player.h - 2; }
        if(deadly(id)) damage(1);
      }
    }
  }
  if(ent===player) ent.on=on;
}

/* Enemies (simple walkers) */
const enemies=[];
function buildEnemies(){
  enemies.length=0;
  const step=14, end=Level.w-24;
  for(let i=10;i<end;i+=step){
    enemies.push({x:i*TILE+4, y:(LEVEL_H-4)*TILE-26, w:20,h:26, vx:60*(Math.random()<.5?-1:1), vy:0, alive:true});
  }
}
function updateEnemies(dt){
  for(const e of enemies){
    if(!e.alive) continue;
    const aheadX=e.x+(e.vx>0?e.w+1:-1);
    const aheadY=e.y+e.h/2;
    const gAhead = tileAt(e.x+e.w/2+(e.vx>0?14:-14), e.y+e.h+2);
    const wAhead = tileAt(aheadX, aheadY);
    if(solid(wAhead) || !solid(gAhead)) e.vx*=-1;

    e.vy += GRAV*dt; if(e.vy>MAX_FALL) e.vy=MAX_FALL;
    resolveX(e, e.vx*dt);
    resolveY(e, e.vy*dt);

    if(AABB(player,e)){
      const prevBottom = player.y + player.h - player.vy*dt;
      if(player.vy>0 && prevBottom <= e.y+6){
        e.alive=false; player.vy=-JUMP_V*0.7;
      }else{ damage(1); }
    }
    if(player.attackT>0){
      const sword={x:player.x+(player.face>0?player.w:-18), y:player.y+6, w:18,h:16};
      if(AABB(sword,e)) e.alive=false;
    }
  }
}

/* Boss + projectiles */
let boss=null; const shuriken=[], shots=[];
function spawnBoss(){
  const x=(Level.w-18)*TILE, y=(LEVEL_H-6)*TILE-40;
  boss={x,y,w:40,h:40,vx:-80,vy:0,hp:12,iFrames:0,shootT:0,jumpT:1.2,on:false,alive:true};
  BossUI.wrap.style.display='flex'; updateBossBar();
}
function updateBossBar(){ if(!boss) return; BossUI.fill.style.width = Math.round(100*boss.hp/12)+'%'; }
function fireShuriken(){ if(!boss) return; const dir=(player.x<boss.x?-1:1); shuriken.push({x:boss.x+boss.w/2, y:boss.y+boss.h/2, w:10,h:10, vx:220*dir, vy:-40}); }
function fireKunai(){ const dir=player.face>0?1:-1; shots.push({x:player.x+(dir>0?player.w:0), y:player.y+10, w:10,h:4, vx:420*dir, life:1.2}); }
function updateProjectiles(dt){
  for(let i=shuriken.length-1;i>=0;i--){
    const p=shuriken[i]; p.vy+=600*dt; p.x+=p.vx*dt; p.y+=p.vy*dt;
    if(p.x<cam.x-100 || p.x>cam.x+C.clientWidth+100 || p.y>LEVEL_H*TILE+200){ shuriken.splice(i,1); continue; }
    if(AABB(player,p)){ damage(1); shuriken.splice(i,1); continue; }
    if(solid(tileAt(p.x,p.y))) shuriken.splice(i,1);
  }
  for(let i=shots.length-1;i>=0;i--){
    const s=shots[i]; s.x+=s.vx*dt; s.life-=dt;
    if(s.life<=0){ shots.splice(i,1); continue; }
    if(solid(tileAt(s.x,s.y))){ shots.splice(i,1); continue; }
    for(const e of enemies){ if(e.alive && AABB(s,e)){ e.alive=false; shots.splice(i,1); break; } }
    if(boss && AABB(s,boss)){ shots.splice(i,1); hurtBoss(1); }
  }
}
function hurtBoss(n){
  if(!boss||boss.iFrames>0) return;
  boss.hp=Math.max(0,boss.hp-n); boss.iFrames=0.35; updateBossBar(); vibrate(25);
  if(boss.hp===0){ boss.alive=false; BossUI.wrap.style.display='none'; spawnDrop(boss.x+boss.w/2,boss.y); boss=null; }
}
function updateBoss(dt){
  if(!boss||!boss.alive) return;
  boss.iFrames=Math.max(0,boss.iFrames-dt);
  boss.jumpT-=dt; if(boss.jumpT<=0 && boss.on){ boss.vy=-520; boss.jumpT=1.6; }
  boss.shootT-=dt; if(boss.shootT<=0){ boss.shootT = (boss.hp>6?1.1:0.7); fireShuriken(); }
  if(Math.abs(player.x-boss.x)<320) boss.vx=(player.x<boss.x?-120:120);
  boss.vy += GRAV*dt; if(boss.vy>MAX_FALL) boss.vy=MAX_FALL;
  resolveX(boss,boss.vx*dt);
  const py=boss.y; resolveY(boss,boss.vy*dt); boss.on = (boss.y===py && boss.vy===0) || boss.on;
  if(AABB(player,boss)) damage(1);
  const prevBottom=player.y+player.h - player.vy*dt;
  if(AABB(player,boss) && player.vy>0 && prevBottom<=boss.y+8){ hurtBoss(1); player.vy=-JUMP_V*0.7; }
}

/* Drops */
const drops=[];
function spawnDrop(x,y){ const type=Math.random()<0.5?'kunai':'flamedash'; drops.push({x:x-10,y:y-10,w:20,h:20,type,vy:-220}); }
function applyDrop(type){ if(type==='kunai'){ special='kunai'; HUD.spec.textContent='Special: Wind Kunai (K)'; } else { special='flamedash'; HUD.spec.textContent='Special: Flame Dash'; igniteDashTimer=0.5; } }
function updateDrops(dt){
  for(let i=drops.length-1;i>=0;i--){
    const d=drops[i]; d.vy+=1200*dt; d.y+=d.vy*dt;
    if(d.y>LEVEL_H*TILE+100){ drops.splice(i,1); continue; }
    if(AABB(player,d)){ applyDrop(d.type); drops.splice(i,1); }
  }
}

/* Specials */
let special='none', specialCd=0, igniteDashTimer=0;
function triggerSpecial(){ if(specialCd>0) return; if(special==='kunai'){ fireKunai(); specialCd=0.25; } else if(special==='flamedash'){ igniteDashTimer=0.5; specialCd=1.0; } }

/* Damage / HUD */
function damage(n){ if(player.iFrames>0) return; player.hp=Math.max(0,player.hp-n); player.iFrames=1.0; player.vy=-320; vibrate(35); if(player.hp===0) respawn(); updateHUD(); }
function respawn(){ player.x=player.spawnX; player.y=player.spawnY; player.vx=player.vy=0; player.hp=3; updateHUD(); }
function updateHUD(){ HUD.hp.textContent='HP: ' + '‚ù§'.repeat(player.hp)+'‚ô°'.repeat(Math.max(0,3-player.hp)); HUD.coins.textContent='Coins: '+player.coins; HUD.spec.textContent = 'Special: ' + (special==='none'?'‚Äî':(special==='kunai'?'Wind Kunai (K)':'Flame Dash')); }

/* Start / Pause / Win */
BTN.play.onclick = ()=> startGame();
BTN.resume.onclick= ()=> togglePause(false);
BTN.restart.onclick=()=>{ togglePause(false); startGame(); };
BTN.menu.onclick  =()=>{ togglePause(false); backToMenu(); };
BTN.again.onclick =()=>{ startGame(); UI.win.style.display='none'; };
BTN.back.onclick  =()=> backToMenu();
function startGame(){
  Level=buildLevel(); LEVEL_W=Level.w; LEVEL_H=Level.h;
  buildEnemies(); shuriken.length=0; shots.length=0; drops.length=0; boss=null; BossUI.wrap.style.display='none';
  player.x=3*TILE; player.y=(LEVEL_H-4)*TILE - player.h; player.spawnX=player.x; player.spawnY=player.y;
  player.vx=player.vy=0; player.hp=3; player.coins=0; player.on=false; player.jumps=0; player.iFrames=0;
  coyote=0; jbuf=0; special='none'; specialCd=0; igniteDashTimer=0;
  UI.title.style.display='none'; UI.pause.style.display='none'; UI.win.style.display='none'; UI.hud.style.display='flex';
  updateHUD();
  cam.x = clamp(player.x - C.clientWidth*0.45, 0, Level.w*TILE - C.clientWidth);
  running=true;
}
function backToMenu(){ running=false; UI.title.style.display='grid'; UI.pause.style.display='none'; UI.win.style.display='none'; UI.hud.style.display='none'; }
function win(){ running=false; UI.win.style.display='grid'; }
function togglePause(force){ const to=(force===undefined? !running : !force); if(to){ running=false; UI.pause.style.display='grid'; } else { UI.pause.style.display='none'; running=true; } }

/* Update (Mario feel) */
function update(dt){
  const left=keys.a||keys.arrowleft, right=keys.d||keys.arrowright, jump=keys[' ']||keys.space, dash=keys.shift, atk=keys.j;

  // timers
  if(jump) jbuf=JUMP_BUF; else jbuf=Math.max(0,jbuf-dt);
  coyote = player.on ? COYOTE_TIME : Math.max(0, coyote-dt);

  player.wasOn=player.on; player.on=false;

  // target velocity: -MAX_RUN..MAX_RUN based on input
  const axis = (right?1:0) - (left?1:0);
  const target = axis * MAX_RUN;
  const accelRate = player.wasOn ? GROUND_ACCEL : AIR_ACCEL;
  player.vx = approach(player.vx, target, accelRate, dt);

  // extra ground friction when no input (kills drift cleanly)
  if(axis===0 && player.wasOn){
    const s = Math.sign(player.vx);
    const mag = Math.min(Math.abs(player.vx), GROUND_FRICTION*dt);
    player.vx -= s*mag;
    if(Math.abs(player.vx)<0.08) player.vx=0;
  }

  if(right) player.face=1; if(left) player.face=-1;

  // dash
  if(dash && player.dashCd<=0){ player.vx += DASH * (player.face>0?1:-1); player.dashCd=.35; }
  player.dashCd=Math.max(0,player.dashCd-dt);

  // attack
  if(atk && player.attackT<=0){ player.attackT=.12; }
  player.attackT=Math.max(0, player.attackT-dt);

  // gravity
  player.vy += GRAV*dt; if(player.vy>MAX_FALL) player.vy=MAX_FALL;

  // integrate vs tiles
  resolveX(player, player.vx*dt);
  resolveY(player, player.vy*dt);

  // buffered/coyote jump AFTER collision
  if(jbuf>0 && (coyote>0 || player.jumps<player.maxJ)){
    player.vy = -JUMP_V * (player.jumps>0 ? 0.95 : 1.0);
    player.jumps++; jbuf=0; keys[' ']=keys.space=false;
  }

  // jump cut (release to shorten)
  if(!keys[' '] && !keys.space && player.vy < -160) player.vy = -160;

  if(player.on) player.jumps=0;

  // death pit
  if(player.y>LEVEL_H*TILE+200){ respawn(); }

  // enemies/boss/projectiles/drops
  updateEnemies(dt);
  if(!boss && player.x > (Level.w-26)*TILE) spawnBoss();
  updateBoss(dt);
  updateProjectiles(dt);
  updateDrops(dt);

  // specials
  specialCd=Math.max(0,specialCd-dt);
  igniteDashTimer=Math.max(0,igniteDashTimer-dt);
  if(igniteDashTimer>0 && boss && AABB(player,boss)) hurtBoss(1);

  // timers
  player.iFrames=Math.max(0,player.iFrames-dt);

  // camera
  const cw=C.clientWidth, worldW=Level.w*TILE;
  const tx=clamp(player.x - cw*0.45, 0, worldW - cw);
  cam.x += (tx - cam.x) * 0.15; cam.y=0;
}

/* Draw */
function draw(t){
  const cw=C.clientWidth, ch=C.clientHeight;

  // sky gradient
  const grad=g.createLinearGradient(0,ch,0,0);
  grad.addColorStop(0,'#8A2232'); grad.addColorStop(.5,'#9B2D3B'); grad.addColorStop(1,'#FFB37E');
  g.fillStyle=grad; g.fillRect(0,0,cw,ch);

  // parallax hills
  drawHills('#33111a', 0.10, 120);
  drawHills('#4a1a24', 0.18,  80);
  drawHills('#642233', 0.28,  48);

  // tiles in view
  const startTx=Math.floor(cam.x/TILE), endTx=Math.ceil((cam.x+cw)/TILE);
  for(let ty=0; ty<LEVEL_H; ty++){
    for(let tx=startTx; tx<Math.min(endTx,LEVEL_W); tx++){
      const id=Level.map[ty][tx]; if(id===0) continue;
      const x=tx*TILE - cam.x, y=ty*TILE - cam.y;
      if(id===1){ g.fillStyle='#2e2a3a'; g.fillRect(x,y,TILE,TILE); }
      if(id===2){ g.fillStyle='#57455d'; g.fillRect(x+2,y+2,TILE-4,TILE-4); }
      if(id===3){ g.fillStyle='gold'; g.beginPath(); g.arc(x+16,y+16,7,0,Math.PI*2); g.fill(); }
      if(id===4){ g.fillStyle='#b43636'; g.beginPath(); g.moveTo(x,y+TILE); g.lineTo(x+TILE/2,y+4); g.lineTo(x+TILE,y+TILE); g.closePath(); g.fill(); }
      if(id===5){ g.fillStyle='#c0ffb3'; g.fillRect(x+20,y-100,6,100); g.fillStyle='#45fd6c';
                  g.beginPath(); g.moveTo(x+26,y-96); g.lineTo(x+80,y-76); g.lineTo(x+26,y-56); g.closePath(); g.fill(); }
      if(id===6){ g.fillStyle='#7ce8ff'; g.fillRect(x+10,y+10,12,12); }
      if(id===9){ g.fillStyle='#ff8a7a'; g.fillRect(x+10,y+6,12,20); }
    }
  }

  // enemies
  g.fillStyle='#ff6e6e';
  for(const e of enemies){ if(!e.alive) continue; g.fillRect(Math.floor(e.x-cam.x),Math.floor(e.y-cam.y),e.w,e.h); }

  // boss
  if(boss){
    g.fillStyle='#ffb3b3'; g.fillRect(Math.floor(boss.x-cam.x),Math.floor(boss.y-cam.y),boss.w,boss.h);
    BossUI.wrap.style.display='flex';
  }

  // boss shuriken
  g.fillStyle='#ffd27a'; for(const p of shuriken){ g.fillRect(Math.floor(p.x-cam.x)-3, Math.floor(p.y-cam.y)-3, 6,6); }
  // player kunai
  g.fillStyle='#c0ffb3'; for(const s of shots){ g.fillRect(Math.floor(s.x-cam.x)-5, Math.floor(s.y-cam.y)-2, 10,4); }

  // drops
  for(const d of drops){
    g.fillStyle = d.type==='kunai' ? '#c0ffb3' : '#ff9c66';
    g.beginPath(); g.arc(Math.floor(d.x-cam.x), Math.floor(d.y-cam.y), 10, 0, Math.PI*2); g.fill();
  }

  // PLAYER SPRITE (simple ninja)
  if(!(player.iFrames>0 && ((t*10|0)%2===0))){
    const px=Math.floor(player.x-cam.x), py=Math.floor(player.y-cam.y);
    const speed=Math.abs(player.vx);
    const step = (speed>10 && player.on) ? Math.sin(t* (6 + speed*0.01)) : 0;
    // shadow
    g.fillStyle='rgba(0,0,0,.25)'; g.beginPath(); g.ellipse(px+player.w/2, py+player.h+4, 10,4, 0, 0, Math.PI*2); g.fill();
    // body
    g.fillStyle='#222'; g.fillRect(px, py, player.w, player.h);
    // headband
    g.fillStyle='#d43c3c'; g.fillRect(px-2, py+3, player.w+4, 4);
    // eyes
    g.fillStyle='#ffecef'; const eyeY=py+10;
    if(player.face>0){ g.fillRect(px+14, eyeY, 3,2); g.fillRect(px+10, eyeY+1, 2,2); }
    else             { g.fillRect(px+4,  eyeY, 3,2); g.fillRect(px+8,  eyeY+1, 2,2); }
    // feet bounce
    g.fillStyle='#333'; g.fillRect(px+3, py+player.h-5 + step*1.5, 6,3);
    g.fillRect(px+player.w-9, py+player.h-5 - step*1.5, 6,3);
  }
  // sword flash
  if(player.attackT>0){
    g.fillStyle='rgba(255,255,255,.25)';
    const sx = player.x + (player.face>0?player.w:-18) - cam.x;
    const sy = player.y+6 - cam.y;
    g.fillRect(Math.floor(sx), Math.floor(sy), 18,16);
  }
}
function drawHills(color, parallax, height){
  const cw=C.clientWidth, ch=C.clientHeight;
  g.save(); g.translate(-cam.x*parallax,0); g.fillStyle=color;
  for(let i=-1;i<12;i++){
    const x=i*240;
    g.beginPath(); g.moveTo(x, ch);
    g.quadraticCurveTo(x+120, ch-height-40, x+240, ch);
    g.closePath(); g.fill();
  }
  g.restore();
}

/* Loop */
let last=performance.now();
function loop(now){
  const dt=Math.min(50,now-last)/1000; last=now;
  if(running) update(dt);
  draw(now/1000);
  requestAnimationFrame(loop);
}
requestAnimationFrame(loop);

/* Wire UI */
function updateBossBar(){ if(!boss) return; BossUI.fill.style.width = Math.round(100*boss.hp/12)+'%'; }
BTN.play.onclick=()=>startGame();
BTN.resume.onclick=()=>togglePause(false);
BTN.restart.onclick=()=>{ togglePause(false); startGame(); };
BTN.menu.onclick=()=>{ togglePause(false); backToMenu(); };
BTN.again.onclick=()=>{ startGame(); UI.win.style.display='none'; };
BTN.back.onclick=()=>backToMenu();

/* Start Game */
function startGame(){
  Level=buildLevel(); LEVEL_W=Level.w; LEVEL_H=Level.h;
  buildEnemies(); shuriken.length=0; shots.length=0; drops.length=0; boss=null; BossUI.wrap.style.display='none';
  player.x=3*TILE; player.y=(LEVEL_H-4)*TILE - player.h; player.spawnX=player.x; player.spawnY=player.y;
  player.vx=player.vy=0; player.hp=3; player.coins=0; player.on=false; player.jumps=0; player.iFrames=0;
  coyote=0; jbuf=0; special='none'; specialCd=0; igniteDashTimer=0;
  UI.title.style.display='none'; UI.pause.style.display='none'; UI.win.style.display='none'; UI.hud.style.display='flex';
  updateHUD();
  cam.x = clamp(player.x - C.clientWidth*0.45, 0, Level.w*TILE - C.clientWidth);
  running=true;
}
function backToMenu(){ running=false; UI.title.style.display='grid'; UI.pause.style.display='none'; UI.win.style.display='none'; UI.hud.style.display='none'; }
</script>
</body>
</html>
